name: ğŸš€ Deploy Flask App to Render

on:
  push:
    branches:
      - main  # ğŸ”¥ Triggers workflow when pushing to `main`

jobs:
  deploy:
    name: ğŸ”„ Deploy Flask App
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v3

    - name: ğŸ Set Up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"  # Updated to Python 3.12

    - name: ğŸ› ï¸ Install Build Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential python3-dev
      # Ensures C compiler and dev libraries for Python 3.12

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt -v --only-binary :all:
        python -m spacy download en_core_web_sm
      timeout-minutes: 15
      # -v for verbose output, --only-binary :all: to prefer wheels
      # Timeout to catch hangs

    - name: ğŸ§  Train & Export Model + Vectorizer
      run: |
        python model/model.py  # âœ… Run the training script
        test -f model/model.pkl && echo "âœ… Model saved: model/model.pkl" || { echo "âŒ Model not found!"; exit 1; }
        test -f model/vectorizer.pkl && echo "âœ… Vectorizer saved: model/vectorizer.pkl" || { echo "âŒ Vectorizer not found!"; exit 1; }
      # Ensures both model.pkl & vectorizer.pkl are created

    - name: ğŸ³ Build & Push Docker Image
      run: |
        docker build -t restaurant-sentiment .
        docker tag restaurant-sentiment:latest ${{ secrets.DOCKER_USERNAME }}/restaurant-sentiment:latest
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
        docker push ${{ secrets.DOCKER_USERNAME }}/restaurant-sentiment:latest
